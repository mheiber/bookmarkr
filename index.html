<body>
<div>
    <a data-bind="bookmark-link">sdf</a>
</div>

<label>title
    <input data-bind="title"></input>
</label>

<label>source
    <textarea data-bind="src" placeholder="paste here"></textarea>
</label>

</body>
<script>
{
    'use strict'
    const findEl = dataBind => document.querySelector(`[data-bind=${dataBind}]`)
    const linkEl = findEl('bookmark-link')
    const titleEl = findEl('title')
    const srcEl = findEl('src')

    let state = {
        src: 'alert("hi")',
        title: 'myBookmarklet'
    }

    const update = newState => {
        state = Object.assign({}, state, newState)
        const uri = `?src=${encodeURIComponent(state.src)}&title=${encodeURIComponent(state.title)}`
        if (uri !== window.history.search) {
            window.history.pushState({}, null, uri)
        }
        srcEl.value = state.src
        linkEl.href = `javascript:(window=>${state.src})()`
        linkEl.textContent = state.title
        titleEl.value = state.title
    }

    const parseSearch = search =>
        !search
            ? {}
            : search
                .slice(1)
                .split('&')
                .map(x => x.split('='))
                .reduce((obj, [k, v]) => Object.assign({}, obj, {[k]: decodeURIComponent(v)}), {})


    const main = () => {

        // update DOM to match initial state
        const initial = parseSearch(window.location.search)
        update(initial)
        // update uri on textarea change
        srcEl.addEventListener('input', e => update({src: e.target.value}))
        titleEl.addEventListener('input', e => update({title: e.target.value}))
    }

    main()

}
</script>